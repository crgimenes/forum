<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>golang chat</title>
  <link rel="stylesheet" href="https://crg.eti.br/crg.css">
</head>

<body onscroll="loadOldContent()">
  <style>
    #inputFieldBox {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #f1f1f1;
      padding: 20px;


      margin: 0 auto;
      max-width: 1024px;
    }

    #inputFieldBox input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #inputBackBox {
      margin: 0;
      padding: 0;
      border: 0;
      background-color: #fff;
    }

    #chat_menu {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #000;
      padding: 20px;

      margin: 0 auto;
      max-width: 1024px;

    }
  </style>

  <!--
menu
-->

  <div id="chat_menu">
    {{if .SessionData}}
    Logged in as {{.SessionData.UserName}} |
    <a href={{.LogoutURL}}>Logout</a>
    {{else}}
    <a href={{.GitHubLoginURL}}>Login</a>
    {{end}}
  </div>
  <!--

-->


  <div id="inputBackBox"></div>

  <div id="inputFieldBox">
    <form onsubmit="submitForm(event)">
      <input type="text" name="inputField">
    </form>
  </div>
</body>

<script>

  ///////////////////////////////////////////////
  // websocket


  var socket = null;
  function connect_socket() {
    console.log("JS connect_socket");
    socket = new WebSocket("ws://localhost:8080/echo");
    socket.onclose = function (event) {
      console.log("JS socket.onclose reconnecting...");
      connect_socket();
    };
    socket.onerror = function (event) {
      console.log("JS socket.onerror reconnecting...");
      connect_socket();
    };
    socket.onopen = function (event) {
      console.log("JS socket.onopen");
      //heartbeat();
    };
  }
  connect_socket();

  function sendToServer(bytes) {
    socket.send(bytes);
    console.log("JS sendToServer: " + bytes);
  }

  function heartbeat() {
    if (!socket) return;
    if (socket.readyState !== 1) return;
    //socket.send("ping");
    setTimeout(heartbeat, 1000);
  }

  socket.onmessage = function (event) {
    var receivedBytes = event.data;
    console.log("JS socket.onmessage: " + receivedBytes);
    if (receivedBytes == "pong") return;
    if (receivedBytes == "ping") {
      //socket.send("pong");
      return;
    }
    ret = writeToScreen(receivedBytes);
    console.log("JS socket.onmessage ret: " + ret);
  }


  /////////////////////////////////////////////////
  // update size

  function updateSize() {
    let inputBackBox = document.getElementById('inputBackBox');
    let inputFieldBox = document.getElementById('inputFieldBox');
    inputBackBox.style.height = (inputFieldBox.offsetHeight - 24) + 'px';
    //inputBackBox.style.width = inputFieldBox.offsetWidth + 'px';
  }

  updateSize();
  window.addEventListener('resize', updateSize);
  /////////////////////////////////////////////////

  function loadOldContent() {
    if (window.scrollY != 0) {
      return;
    }
    console.log("load old content...");


    let newElement = document.createElement('p');
    newElement.id = 'newElement';
    newElement.className = 'newElement';
    newElement.style.color = 'red';
    newElement.style.fontSize = '20px';
    const textNode = document.createTextNode("load old content...");
    newElement.appendChild(textNode);
    document.body.insertBefore(newElement, document.body.firstChild);

  }


  function insertStringAboveForm(string) {
    // const form = document.querySelector('form');
    const form = document.getElementById('inputBackBox');
    //const newElement = document.createElement('p');
    let newElement = document.createElement('p');
    newElement.id = 'newElement';
    newElement.className = 'newElement';
    newElement.style.color = 'red';
    newElement.style.fontSize = '20px';


    const textNode = document.createTextNode(string);
    newElement.appendChild(textNode);
    form.parentNode.insertBefore(newElement, form);
  }

  function scrollToBottom() {
    window.scrollTo(0, document.body.scrollHeight);
  }

  function submitForm(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const inputValue = formData.get("inputField");
    console.log(inputValue);
    insertStringAboveForm(inputValue);
    scrollToBottom();

    // POST
    fetch("/url/do/seu/servidor", {
      method: "POST",
      body: JSON.stringify({ input: inputValue }),
      headers: {
        "Content-Type": "application/json",
      },
    });
    event.target.reset();
  }
</script>

</html>